name: NuGet Publish

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

jobs:
  publish:
    name: Publish NuGet Package

    environment: nuget.org

    permissions:
      contents: write

    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5

      - name: Build
        run: dotnet build -c Release

      - name: Publish Blism.Core Package
        run: dotnet nuget push Blism.Core/bin/Release/*.nupkg -k ${{ secrets.NUGET_API_KEY }} -s https://api.nuget.org/v3/index.json

      - name: Publish Other Packages
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          publish_folder() {
            local base="$1"
            local label="$2"

            for dir in "$base"*/; do
              name=$(basename "$dir")
              [[ "$name" =~ \.Test$ ]] && continue

              echo "::group::Publishing ${label}${name}"

              if ! dotnet nuget push "$dir/bin/Release/"*.nupkg \
                -k "${{ secrets.NUGET_API_KEY }}" \
                -s https://api.nuget.org/v3/index.json; then
                echo "::error::Failed to publish ${label}${name}"
              fi

              echo "::endgroup::"
            done
          }

          # Engines/<Project>
          publish_folder "Engines/" ""

          # Languages/<Language>/<Package>
          for language in Languages/*/; do
            language_name=$(basename "$language")
            publish_folder "$language" "$language_name / "
          done

          # Themes/<Project>
          publish_folder "Themes/" ""

          # Bundles/<Project>
          publish_folder "Bundles/" ""

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          make_latest: true
